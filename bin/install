#!/usr/bin/env bash
# Called once during the initial instantiation of the cartridge

# We install all libraries into the usr directory, as these are
# shared amongst all instances of this cartridge.
function install() {
    name=$( echo ${1}_DIR | tr '[:lower:]' '[:upper:]' )

    # We install all libraries into the usr directory, as these are
    # shared amongst all instances of this cartridge. So no need to
    # copy over if it already exists
    if [ ! -d ${!name} ]; then

        # Extract gzipped tar file out to temp for compilation
        tar -xf $OPENSHIFT_GEO_DIR/usr/opt/$1.tar.gz -C /tmp

        mkdir ${!name}
        pushd /tmp/$1 > /dev/null

        # With some installations, additional steps are required
        # before the installation should occur (e.g. GeoIP). Run
        # these here
        if [ -n $2 ]; then $2; fi

        # Configure
        echo "Configuring $1"
        ./configure --prefix=${!name}

        # Install
        echo "Installing $1"
        make && make install

        popd > /dev/null
    fi
}

# GeoIP must be "bootstrapped" before configuration, which also
# installs the necessary database file for use in IP address lookups
function _geoip_install() {
    ./bootstrap
    cp "data/GeoIP.dat" $GEOIP_DIR/lib
}

# Begin the installation process
install python
install geoip _geoip_install

# Here we create the virtual environment and install the initial 
# python packages
$PYTHON_DIR/bin/python3 $PYTHON_DIR/bin/pyvenv $VIRTUAL_ENV_DIR
source $VIRTUAL_ENV_DIR/bin/activate
pip install -r $OPENSHIFT_GEO_DIR/conf/requirements.txt
deactivate
